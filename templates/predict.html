{% extends "base.html" %}
{% block content %}
<div class="row g-4">
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h5 class="mb-0">Row {{ row_idx }} – Event Details</h5>
      </div>
      <div class="card-body">
        <dl class="row small">
          {% for k, v in row.items() %}
            <dt class="col-sm-5 text-muted">{{ k }}</dt>
            <dd class="col-sm-7">{{ v }}</dd>
          {% endfor %}
        </dl>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h5 class="mb-0">SentinelX Prediction</h5>
      </div>
      <div class="card-body">
        <p class="mb-1 fw-semibold">Predicted Attack Labels:</p>
        <div class="mb-3">
          {% for lbl in predicted_labels %}
            <span class="badge badge-attack">{{ lbl }}</span>
          {% endfor %}
        </div>

        <p class="mb-2 fw-semibold">Label Probabilities:</p>
        <div class="small mb-3">
          {% for item in prob_list %}
            <div class="d-flex justify-content-between">
              <span>{{ item.label }}</span>
              <span>
                {% if item.prob is not none %}
                  {{ "%.2f"|format(item.prob) }}
                {% else %}
                  –
                {% endif %}
              </span>
            </div>
            <div class="prob-bar-bg mb-2">
              {% if item.prob is not none %}
                <div class="prob-bar-fill" style="width: {{ (item.prob * 100)|round(0) }}%;"></div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <hr>

        <p class="mb-1 fw-semibold">MITRE ATT&CK Mapping:</p>
        <div class="small mb-3">
          {% if mitre_info and mitre_info|length > 0 %}
            <ul class="mb-0">
              {% for m in mitre_info %}
                <li>
                  <strong>{{ m.label }}</strong> →
                  <span class="text-info">{{ m.tactic }}</span>,
                  <span class="text-warning">{{ m.technique }}</span><br>
                  <span class="text-muted">{{ m.desc }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <span class="text-muted">No MITRE mapping available.</span>
          {% endif %}
        </div>

        <hr>

        <p class="mb-1 fw-semibold">Top Influencing Features (Explainability):</p>
        <div class="small mb-3">
          {% if shap_available and shap_info %}
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Feature</th>
                  <th>Impact (|SHAP|)</th>
                </tr>
              </thead>
              <tbody>
                {% for item in shap_info %}
                  <tr>
                    <td>{{ item.feature }}</td>
                    <td>{{ "%.4f"|format(item.value) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% elif shap_available and not shap_info %}
            <span class="text-muted">SHAP is enabled but explanation failed for this row.</span>
          {% else %}
            <span class="text-muted">SHAP not installed. Install with <code>pip install shap</code> to enable.</span>
          {% endif %}
        </div>

        <div class="mt-3 d-flex gap-2">
          <a href="{{ url_for('browse') }}" class="btn btn-outline-light btn-sm">Back to Rows</a>
          <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary btn-sm">View Dashboard</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
